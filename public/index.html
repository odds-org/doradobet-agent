<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Paul â€” DoradoBet Agent</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f0f13; color: #e8e8e8;
      height: 100dvh; display: flex; flex-direction: column; align-items: center;
    }
    .header {
      width: 100%; max-width: 680px;
      padding: 14px 20px 12px;
      display: flex; align-items: center; gap: 12px;
      border-bottom: 1px solid #1e1e2a;
    }
    .avatar {
      width: 40px; height: 40px;
      background: linear-gradient(135deg, #f5a623, #e8850a);
      border-radius: 50%; display: flex; align-items: center;
      justify-content: center; font-size: 20px; flex-shrink: 0;
    }
    .header-info h2 { font-size: 16px; font-weight: 600; }
    .header-info p  { font-size: 12px; color: #6b7280; }
    .status-dot {
      width: 8px; height: 8px; background: #22c55e;
      border-radius: 50%; margin-left: auto;
      box-shadow: 0 0 6px #22c55e;
    }
    .user-bar {
      width: 100%; max-width: 680px; padding: 7px 20px;
      display: flex; align-items: center; gap: 8px;
      background: #11111a; border-bottom: 1px solid #1e1e2a;
    }
    .user-bar label { font-size: 11px; color: #6b7280; white-space: nowrap; }
    .user-bar input {
      flex: 1; background: #1a1a26; border: 1px solid #2d2d3d;
      border-radius: 6px; color: #e8e8e8; padding: 5px 10px; font-size: 12px;
    }
    .user-bar button {
      background: #1e2a1a; border: 1px solid #2d4a2d; color: #86efac;
      padding: 5px 12px; border-radius: 6px; font-size: 11px; cursor: pointer;
    }
    .user-bar button:hover { background: #253321; }
    .messages {
      flex: 1; width: 100%; max-width: 680px;
      overflow-y: auto; padding: 16px 20px;
      display: flex; flex-direction: column; gap: 10px;
    }
    .messages::-webkit-scrollbar { width: 4px; }
    .messages::-webkit-scrollbar-thumb { background: #2d2d3d; border-radius: 2px; }
    .sys-msg { text-align: center; font-size: 11px; color: #4b5563; padding: 2px 0; }
    .msg { display: flex; gap: 8px; max-width: 90%; }
    .msg.user { align-self: flex-end; flex-direction: row-reverse; }
    .msg.paul { align-self: flex-start; }
    .bubble {
      padding: 10px 14px; border-radius: 16px;
      font-size: 14px; line-height: 1.5; max-width: 100%;
    }
    .paul .bubble {
      background: #1a1a26; border: 1px solid #2d2d3d;
      border-bottom-left-radius: 4px; color: #e8e8e8;
    }
    .user .bubble {
      background: #f5a623; color: #0f0f13;
      border-bottom-right-radius: 4px; font-weight: 500;
    }
    .msg-time { font-size: 10px; color: #4b5563; align-self: flex-end; flex-shrink: 0; }
    .events-wrapper { display: flex; flex-direction: column; gap: 6px; margin-top: 8px; }
    .event-card {
      background: #12121e; border: 1px solid #2d2d3d;
      border-radius: 10px; padding: 10px 12px;
      text-decoration: none; display: block;
      transition: border-color .15s, background .15s;
    }
    .event-card:hover { border-color: #f5a623; background: #1a1616; }
    .event-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; }
    .event-name { font-size: 13px; font-weight: 600; color: #f0f0f0; }
    .event-live {
      font-size: 10px; background: #dc2626; color: white;
      padding: 2px 6px; border-radius: 4px; font-weight: 700; flex-shrink: 0;
      animation: blink 1.5s infinite;
    }
    @keyframes blink { 0%,100% { opacity:1 } 50% { opacity:.5 } }
    .event-league { margin-top: 3px; font-size: 11px; color: #6b7280; }
    .event-odds  { margin-top: 5px; font-size: 12px; color: #fbbf24; }
    .event-date  { margin-top: 3px; font-size: 11px; color: #4b5563; }
    .error-bubble {
      background: #1f0f0f; border: 1px solid #7f1d1d;
      color: #fca5a5; border-radius: 10px;
      padding: 8px 12px; font-size: 13px; margin-top: 4px;
    }
    .typing {
      display: flex; align-items: center; gap: 4px;
      padding: 12px 14px; background: #1a1a26;
      border: 1px solid #2d2d3d; border-radius: 16px;
      border-bottom-left-radius: 4px; width: fit-content;
    }
    .typing span {
      width: 6px; height: 6px; background: #6b7280;
      border-radius: 50%; animation: bounce 1.2s infinite;
    }
    .typing span:nth-child(2) { animation-delay: .2s; }
    .typing span:nth-child(3) { animation-delay: .4s; }
    @keyframes bounce { 0%,60%,100% { transform:translateY(0) } 30% { transform:translateY(-6px) } }
    .quick-replies {
      width: 100%; max-width: 680px;
      padding: 0 20px 8px;
      display: flex; gap: 6px; flex-wrap: wrap;
    }
    .qr-btn {
      background: #1a1a26; border: 1px solid #2d2d3d;
      color: #9ca3af; padding: 5px 12px;
      border-radius: 20px; font-size: 12px; cursor: pointer;
      transition: border-color .15s, color .15s;
    }
    .qr-btn:hover { border-color: #f5a623; color: #f5a623; }
    .input-bar {
      width: 100%; max-width: 680px;
      padding: 10px 20px 18px;
      display: flex; gap: 8px; align-items: flex-end;
      border-top: 1px solid #1e1e2a;
    }
    textarea {
      flex: 1; background: #1a1a26; border: 1px solid #2d2d3d;
      border-radius: 12px; color: #e8e8e8; font-size: 14px;
      padding: 10px 14px; resize: none; min-height: 44px;
      max-height: 120px; outline: none; font-family: inherit;
      line-height: 1.4; transition: border-color .15s;
    }
    textarea:focus { border-color: #f5a623; }
    textarea::placeholder { color: #4b5563; }
    .send-btn {
      width: 44px; height: 44px; background: #f5a623;
      border: none; border-radius: 12px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; transition: background .15s, transform .1s;
    }
    .send-btn:hover:not(:disabled) { background: #e8950f; }
    .send-btn:active:not(:disabled) { transform: scale(.95); }
    .send-btn:disabled { background: #2d2d3d; cursor: default; }
    .send-btn svg { width: 18px; height: 18px; }
  </style>
</head>
<body>

<div class="header">
  <div class="avatar">ğŸ†</div>
  <div class="header-info">
    <h2>Paul</h2>
    <p>Experto en apuestas Â· DoradoBet</p>
  </div>
  <div class="status-dot"></div>
</div>

<div class="user-bar">
  <label>userId:</label>
  <input type="text" id="userId" value="demo-user-001" />
  <button onclick="resetUser()">ğŸ”„ Reset perfil</button>
</div>

<div class="messages" id="messages"></div>

<div class="quick-replies">
  <button class="qr-btn" onclick="quickSend('hay partidos en vivo?')">ğŸ”´ En vivo</button>
  <button class="qr-btn" onclick="quickSend('quÃ© hay hoy de NBA?')">ğŸ€ NBA hoy</button>
  <button class="qr-btn" onclick="quickSend('partidos de fÃºtbol esta semana')">âš½ FÃºtbol</button>
  <button class="qr-btn" onclick="quickSend('quiero armar un parlay')">ğŸ¯ Parlay</button>
</div>

<div class="input-bar">
  <textarea id="msgInput" placeholder="EscrÃ­bele a Paul..." rows="1"
    onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
  <button class="send-btn" id="sendBtn" onclick="sendMessage()">
    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"
         stroke-linecap="round" stroke-linejoin="round">
      <line x1="22" y1="2" x2="11" y2="13"></line>
      <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
    </svg>
  </button>
</div>

<script>
  // â”€â”€â”€ state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var sessionId = 'demo-' + Date.now()
  var corrCount = 0
  var isFirstMsg = true
  var busy = false
  var chatHistory = []

  // â”€â”€â”€ DOM helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var msgs = document.getElementById('messages')

  function t(tag, cls, txt) {
    var el = document.createElement(tag)
    if (cls) el.className = cls
    if (txt !== undefined) el.textContent = txt
    return el
  }

  function ts() {
    return new Date().toLocaleTimeString('es-CO', { hour:'2-digit', minute:'2-digit' })
  }

  function scrollDown() {
    msgs.scrollTop = msgs.scrollHeight
  }

  function addSys(text) {
    var el = t('div', 'sys-msg', text)
    msgs.appendChild(el)
    scrollDown()
  }

  function addUserMsg(text) {
    var row = t('div', 'msg user')
    var timeEl = t('span', 'msg-time', ts())
    var bub = t('div', 'bubble', text)
    row.appendChild(timeEl)
    row.appendChild(bub)
    msgs.appendChild(row)
    scrollDown()
  }

  function showTyping() {
    var row = t('div', 'msg paul')
    row.id = 'typing-row'
    var dots = t('div', 'typing')
    dots.appendChild(t('span'))
    dots.appendChild(t('span'))
    dots.appendChild(t('span'))
    row.appendChild(dots)
    msgs.appendChild(row)
    scrollDown()
    return row
  }

  function removeTyping() {
    var el = document.getElementById('typing-row')
    if (el) el.remove()
  }

  function addErrorMsg(text) {
    var row = t('div', 'msg paul')
    var bub = t('div', 'error-bubble')
    bub.textContent = 'âš ï¸ ' + text
    row.appendChild(bub)
    msgs.appendChild(row)
    scrollDown()
  }

  // â”€â”€â”€ Render MODULE 5 response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderResponse(mod5) {
    var data = mod5.data || {}
    var message = data.message || ''
    var events = data.liveEvents || data.upcomingEvents || []
    var isLive = !!(data.liveEvents)

    var row = t('div', 'msg paul')
    var bub = t('div', 'bubble')

    // Main message text
    if (message) {
      bub.textContent = message
    }

    // Event cards
    if (events.length > 0) {
      var wrapper = t('div', 'events-wrapper')

      events.forEach(function(ev) {
        var card = document.createElement('a')
        card.className = 'event-card'
        card.href = ev.url || '#'
        card.target = '_blank'
        card.rel = 'noopener noreferrer'

        // Top row: name + live badge
        var top = t('div', 'event-top')
        var name = t('span', 'event-name', ev.name || '')
        top.appendChild(name)
        if (isLive) {
          top.appendChild(t('span', 'event-live', 'EN VIVO'))
        }
        card.appendChild(top)

        // League / sport
        var league = [ev.sport, ev.league, ev.category].filter(Boolean).join(' Â· ')
        if (league) card.appendChild(t('div', 'event-league', league))

        // Odds / description
        if (ev.description) card.appendChild(t('div', 'event-odds', ev.description))

        // Date
        if (ev.startDate) {
          try {
            var d = new Date(ev.startDate).toLocaleString('es-CO', {
              month: 'short', day: 'numeric',
              hour: '2-digit', minute: '2-digit',
              timeZone: 'America/Bogota'
            })
            card.appendChild(t('div', 'event-date', 'ğŸ“… ' + d))
          } catch(e) {}
        }

        wrapper.appendChild(card)
      })

      bub.appendChild(wrapper)
    }

    var timeEl = t('span', 'msg-time', ts())
    row.appendChild(bub)
    row.appendChild(timeEl)
    msgs.appendChild(row)
    scrollDown()
  }

  // â”€â”€â”€ Send â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getUserId() {
    return document.getElementById('userId').value.trim() || 'demo-user-001'
  }

  function quickSend(text) {
    document.getElementById('msgInput').value = text
    sendMessage()
  }

  function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage() }
  }

  function autoResize(el) {
    el.style.height = 'auto'
    el.style.height = Math.min(el.scrollHeight, 120) + 'px'
  }

  async function sendMessage() {
    if (busy) return
    var input = document.getElementById('msgInput')
    var text = input.value.trim()
    if (!text) return

    input.value = ''
    input.style.height = 'auto'
    addUserMsg(text)
    showTyping()
    busy = true
    document.getElementById('sendBtn').disabled = true

    chatHistory.push({ role: 'user', content: text })

    // Abort after 45s so the UI never stays stuck
    var controller = new AbortController()
    var timeoutId = setTimeout(function() { controller.abort() }, 240000)

    try {
      var res = await fetch('/webhook', {
        method: 'POST',
        signal: controller.signal,
        headers: {
          'Content-Type': 'application/json',
          'x-odds-api-key': 'MsuysfPCjbpy9faAWMogyC'
        },
        body: JSON.stringify({
          message: text,
          userId: getUserId(),
          sessionId: sessionId,
          clientId: 'demo-ui',
          correlationId: 'demo-' + Date.now() + '-' + (++corrCount),
          context: chatHistory.slice(-10, -1),
          firstMessage: isFirstMsg,
          agentName: 'Paul'
        })
      })

      clearTimeout(timeoutId)
      isFirstMsg = false
      removeTyping()

      if (!res.ok) { addErrorMsg('Error HTTP ' + res.status); return }

      var mod5 = await res.json()

      // Show response even if message is empty (avoid invisible bubbles)
      if (!mod5 || !mod5.data || !mod5.data.message) {
        addErrorMsg('Paul no respondiÃ³. Intenta de nuevo.')
        return
      }

      renderResponse(mod5)

      var replyText = mod5.data.message || ''
      if (replyText) chatHistory.push({ role: 'assistant', content: replyText })

    } catch(err) {
      clearTimeout(timeoutId)
      removeTyping()
      if (err.name === 'AbortError') {
        addErrorMsg('Paul tardÃ³ demasiado (>4min). Intenta de nuevo.')
      } else {
        addErrorMsg(err.message || 'Error de conexiÃ³n â€” Â¿estÃ¡ corriendo el servidor?')
      }
    } finally {
      busy = false
      document.getElementById('sendBtn').disabled = false
      document.getElementById('msgInput').focus()
    }
  }

  // â”€â”€â”€ Reset user (borra perfil de PG) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function resetUser() {
    var uid = getUserId()
    if (!confirm('Â¿Borrar perfil de "' + uid + '"?\nSe reiniciarÃ¡ el onboarding.')) return
    try {
      var res = await fetch('/api/reset-user?userId=' + encodeURIComponent(uid), { method: 'DELETE' })
      if (res.ok) {
        chatHistory = []; isFirstMsg = true
        sessionId = 'demo-' + Date.now()
        msgs.textContent = ''
        addSys('Perfil de "' + uid + '" borrado Â· Listo para onboarding')
      } else {
        addSys('No se pudo borrar el perfil (' + res.status + ')')
      }
    } catch(e) {
      addSys('Error: ' + e.message)
    }
  }

  // â”€â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  addSys('Paul online Â· ' + new Date().toLocaleTimeString('es-CO'))
  document.getElementById('msgInput').focus()
</script>
</body>
</html>
